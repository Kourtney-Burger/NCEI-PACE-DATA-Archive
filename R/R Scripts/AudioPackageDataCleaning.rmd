---
title: "Audio Package Data Cleaning"
author: "Kourtney Burger"
date: "2024-10-07"
output: html_document
---

Data cleaning script to combine deployment details, calibration, and other deployment information into one spreadsheet that can be converted to PACE (using custom translator)

# Set up: Required Packages, functions, and set WD
```{r, echo=FALSE}
# Load packages
library(here)
library(readr)
library(readxl)
library(writexl)
library(dplyr)
library(lubridate)

#Taiki's date function
posixToText <- function(x) {
    format(x, '%Y-%m-%dT%H:%M:%S')
}

# Set working directory
Dir <- here::here()
```

# Import Data

Identify which drifts need to be packaged and download data from the 'New Deployment To Save' sheet on [deploymentDetails spreadsheet](https://docs.google.com/spreadsheets/d/10bxlwfVOe1LFfj69B_YddxcA0V14m7codYwgD2YncFk/edit?gid=395545420#gid=395545420)

## Deployment Details
```{r}
dd <- read.csv('Test Spreadsheets/Deployment Details - NEW DEPLOYMENT TO SAVE.csv')
```

## PACE Templates
```{r}
MobileMarineTemplate <- read_excel('Test Spreadsheets/Templates/Mobile-Marine-NCEI-PACE-Template.xlsx')
```


# Prep and Clean Data
## For testing, subset CalCurCEAS drifts
```{r}
dd <- subset(dd, Project == "CalCurCEAS")
```

## Remove lost or sunk drifts
```{r}
dd <- subset(dd, Status...In.Prep.....preparing.buoy.for.deployment..Active....at.sea.and.we.plan.to.recover..Lost....at.sea.but.unlikely.we.can.recover..Sunk....only.recovered.partial.buoy..assumed.dead..sunk..and.highly.unlikely.to.recover..Complete.....buoy.recovered.and.data.is.in.house..Unusable....buoy.recovered.but.data.is.unusable == "Complete")
```

## Fix Dates
```{r}
# Date should be formatted as YYYY-MM-DD
dd$Date..UTC <- as.Date(dd$Date..UTC, format = "%m/%d/%Y")
dd$Date..UTC <- dd$Date..UTC + years(2)
dd$Date..UTC<- as.character(dd$Date..UTC)

#Date times should be formatted as YYYY-MM-DDTHH:MM:SS
dd$Deployment_Date_UTC <- as.POSIXct(dd$Deployment_Date_UTC, format = "%m/%d/%Y %H:%M:%S", tz = 'UTC')
dd$Deployment_Date_UTC <- posixToText(dd$Deployment_Date_UTC)

dd$Recovery_Date_UTC <- as.POSIXct(dd$Recovery_Date_UTC, format = "%m/%d/%Y %H:%M:%S", tz = 'UTC')
dd$Recovery_Date_UTC <- posixToText(dd$Recovery_Date_UTC)

dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA. <- as.POSIXct(dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA., format = "%m/%d/%Y %H:%M:%S", tz = 'UTC')
dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA. <- posixToText(dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.)

dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA. <- as.POSIXct(dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA., format = "%m/%d/%Y %H:%M:%S", tz = 'UTC')
dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA. <- posixToText(dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.)
```

## Rename Recorder Types
```{r}
dd$Type[dd$Type == "ST640"] <- "SoundTrap 640"
dd$Type[dd$Type == "ST4300HF"] <- "SoundTrap 4300 High Frequency"
dd$Type[dd$Type == "ST300"] <- "SoundTrap 300"
dd$Type[dd$Type == "ST4300STD"] <- "SoundTrap 4300"
dd$Type[dd$Type == "ST500HF"] <- "SoundTrap 500 High Frequency"
dd$Type[dd$Type == "ST300HF"] <- "SoundTrap 300 High Frequency"
```

## Rename Sites
```{r}
dd$Site[dd$Site == "WAS"] <- "Washington"
dd$Site[dd$Site == "COL"] <- "Columbia River"
dd$Site[dd$Site == "ORE"] <- "Oregon"
dd$Site[dd$Site == "HUM"] <- "Humboldt"
dd$Site[dd$Site == "MND"] <- "Mendocino"
dd$Site[dd$Site == "PTA"] <- "Point Arena"
dd$Site[dd$Site == "SFB"] <- "San Francisco Bay"
dd$Site[dd$Site == "HMB"] <- "Half Moon Bay"
dd$Site[dd$Site == "MBY"] <- "Monterey Bay"
dd$Site[dd$Site == "MOB"] <- "Morro Bay"
dd$Site[dd$Site == "CHI"] <- "Channel Islands"
dd$Site[dd$Site == "LAB"] <- "Los Angeles Basin"
dd$Site[dd$Site == "SND"] <- "San Diego"
dd$Site[dd$Site == "BCN"] <- "Baja California Norte"
dd$Site[dd$Site == "BCS"] <- "Baja California Sur"
```

# Setup PACE Spreadsheet
## Fix columns to match PACE template
```{r}
#MobileMarineTemplate$`Data Collection Name` <- paste0('SWFSC', dd$Data_ID)

MobileMarineData <- data.frame(
  'Data Collection Name' = paste0('SWFSC-', dd$Drift.), #Package name?
#  'Site Or Cruise Name' = '', #Not used by us
  'Time Zone' = 'UTC',
  'Dataset Type' = 'Audio',
#  "Location Type" = '', #???
  "Deployment Id" = dd$Drift.,
  "Dataset Packager" = 'Kourtney Burger',
  "Projects" = dd$Project,
  "Public Release Date" = dd$Date..UTC,
  "Scientists" = dd$Personnel,
  "Sources" = 'BOEM', # What is this, sponsers? FIX FIELD
#  "Funders" = '', #Check with Jeff/Shannon
  "Platform" = 'Drifter',                                 
  "Instrument" = dd$Type,                               
  "Instrument Id" = dd$Instrument_ID..serial.number.,               
  "Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,                              
  "End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,                                 
#  "Pre Deployment Calibration Date" = '',
#  "Post Deployment Calibration Date" = '',         
  "Calibration Description" = 'This dataset is composed of multichannel recorders with different types of hydrophones, each with its own unique sensitivity and frequency range. For the detailed calibration information refer to the CalCurCEAS_CalibrationInfo.csv spreadsheet.', #Create calibration sheet from inventory                 
  "Deployment Title" = 'California Current Cetacean Ecosystem Assessment Surve (CalCurCEAS)',
#  "Deployment Purpose" = '', # Ask Jeff                      
#  "Deployment Description" = '', #Not used                   
  "Alternate Site Name" = dd$Site,                      
#  "Alternate Deployment Name" = '', # Not used                  
  "Quality Analyst" = dd$Quality_Analyst,                          
#  "Quality Analysis Objectives" = '',              
#  "Quality Analysis Method" = '',                  
#  "Quality Assessment Description" = '',           
  "Deployment Time" = dd$Deployment_Date_UTC,
  "Recovery Time" = dd$Recovery_Date_UTC,
#  "Comments" = '',                                 
#  "Uuid" = '',                                     
#  "Temperature Path" = '', #no temp data                       
#  "Biological Path" = '', #no bio data                          
#  "Other Path" = '', #include                                
#  "Documents Path" = '', # no docs until published                
#  "Calibration Documents Path" = '', # link to calibration file
  "Navigation Path" = paste0('Z:/METADATA/CalCurCEAS_2024/', dd$Drift., '/', dd$Drift., '_GPS'),    
  "Source Path" =  paste0('Z:/RECORDINGS/DRIFTERS/CalCurCEAS_2024/RAW/', dd$Drift.,'/wav sample'), # Path to auido data   
  "Sea Area" = 'North Pacific Ocean',  
  "Vessel" = dd$Deploy.Vessel,                                   
  "Location Derivation Description" = 'Location derived from GPS data affixed to top of drifting buoy',          
#  "File(s)" = '', # What is this?                                 
  "Quality Entries (0) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Quality Entries (0) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,  
  "Quality Entries (0) Min Frequency" = dd$Quality_LowFreq,        
  "Quality Entries (0) Max Frequency" = dd$Quality_HighFreq,        
  "Quality Entries (0) Quality Level" = 'Good',        
#  "Quality Entries (0) Comments" = '',             
  "Channels (0) Sensor" = dd$SensorNumber_1..hydrophone.serial.number.,                      
  "Channels (0) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (0) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (0) Sample Rates (0) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (0) Sample Rates (0) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA., 
  "Channels (0) Sample Rates (0) Sample Rate" = dd$SampleRate_kHz,
  "Channels (0) Sample Rates (0) Sample Bits" = '16',
  "Channels (0) Duty Cycles (0) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (0) Duty Cycles (0) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA., 
  "Channels (0) Duty Cycles (0) Duration" = '6',    
  "Channels (0) Duty Cycles (0) Interval" = '6',    
  "Channels (0) Gains (0) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (0) Gains (0) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,  
#  "Channels (0) Gains (0) Gain" = '',
  "Channels (1) Sensor" = dd$SensorNumber_2...hydrophone.serial.number.,                      
  "Channels (1) Start Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,  
  "Channels (1) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA., 
  "Channels (1) Sample Rates (1) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (1) Sample Rates (1) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,  
  "Channels (1) Sample Rates (1) Sample Rate" = dd$SampleRate_kHz,
  "Channels (1) Sample Rates (1) Sample Bits" = '16',
  "Channels (1) Duty Cycles (1) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (1) Duty Cycles (1) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,  
  "Channels (1) Duty Cycles (1) Duration" = '6',    
  "Channels (1) Duty Cycles (1) Interval" = '6',    
  "Channels (1) Gains (1) Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Channels (1) Gains (1) End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,  
#  "Channels (1) Gains (1) Gain" = '',
  "Sensor" = 'GPS test', # FIX                                  
  "Position X" = '0',  # FIX                             
  "Position Y" = '0', # FIX                             
  "Position Z" = '+1', # FIX                               
  "Audio Start Time" = dd$Data_Start_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  "Audio End Time" = dd$Data_End_UTC..defined.once.data.is.recovered.by.scanning.LTSA.,
  
  check.names=FALSE
  )
```


# Export spreadsheet
```{r}
#write.csv(MobileMarineData, file = "C:/Users/kourtney.burger/Documents/Data Archive/NCEI/PACE/PACE-NCEI/Test Spreadsheets/MobileMarineData.csv", row.names = FALSE)

write_xlsx(MobileMarineData, "C:/Users/kourtney.burger/Documents/Data Archive/NCEI/PACE/PACE-NCEI/Test Spreadsheets/MobileMarineData.xlsx")
```


